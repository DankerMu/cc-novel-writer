# 去 AI 化规则详解

本文档定义 novel 插件系统的完整去 AI 化策略，供 ChapterWriter、StyleRefiner、QualityJudge 参考。

## Layer 1: 风格锚定（输入层）

### 风格指纹提取

StyleAnalyzer 从用户样本中提取以下可量化特征：

- **avg_sentence_length**：平均句长（字数），用于校准生成文本的句式节奏
- **dialogue_ratio**：对话占全文比例，控制叙述与对话的平衡
- **rhetoric_preferences**：修辞偏好列表（频率标注），如比喻、排比、短句切换
- **forbidden_words**：作者从不使用的词汇（精准收录，不过度泛化）
- **character_speech_patterns**：角色语癖，需有样本中的具体例句支撑
- **writing_directives**：正向写作指令（可执行的风格指南数组），用于直接注入 ChapterWriter prompt

### 风格样本降级方案

当用户无自有样本时：
1. **仿写模式**（推荐）：指定参考作者 → 提取风格指纹 → 标记 `source_type: "reference"`
2. **先写后提**：用户先写 1 章 → 再提取
3. **预置模板**：选择预设风格模板（轻松幽默/热血少年/细腻言情等）→ 微调

### 风格漂移监控

每 5 章提取一次当前输出的风格特征，与 style-profile.json 对比：
- 句长偏移 > 20% → 警告
- 对话比例偏移 > 15% → 警告
- 新出现的高频 AI 用语 → 追加到黑名单

**自动纠偏**：当漂移超阈值时，将偏离项写入 `style-drift.json`，自动注入后续 ChapterWriter 和 StyleRefiner 的 context：
```json
{
  "detected_chapter": 25,
  "drifts": [
    {"metric": "avg_sentence_length", "baseline": 18, "current": 24, "directive": "句子过长，回归短句节奏"},
    {"metric": "dialogue_ratio", "baseline": 0.4, "current": 0.28, "directive": "对话偏少，增加角色互动"}
  ],
  "injected_to": ["ChapterWriter", "StyleRefiner"]
}
```
纠偏指令会持续注入直至下次检测确认回归基线（偏移 < 10%）。

## Layer 2: 约束注入（生成层）

ChapterWriter prompt 中注入以下硬约束：

### 2.1 AI 用语黑名单

从 `ai-blacklist.json` 加载，生成时完全禁止。包含但不限于：
- 情感描写类：不禁、莫名、油然而生、心中暗道、嘴角微微上扬
- 过渡连接类：与此同时、值得一提的是、毫无疑问
- 形容夸张类：宛如、恍若、仿佛置身于
- 详见 `${CLAUDE_PLUGIN_ROOT}/templates/ai-blacklist.json`

### 2.2 角色语癖

每个重要角色至少定义 1 个口头禅或说话习惯：
- 口头禅出现频率：每 2-3 次对话出现 1 次（不可每句都加）
- 语癖需符合角色背景（文化人用文言、江湖人用俚语）
- 不同角色的语癖必须可区分

### 2.3 反直觉细节

每章至少 1 处"反直觉"的生活化细节，例如：
- 打斗中途想起锅里还炖着汤
- 修炼突破时被蚊子咬了一口
- 严肃对话中对方裤子上有个洞

目的：打破 AI 生成文本的"完美感"和"刻板感"。

### 2.4 场景描写限制

- 场景描写最多 2 句，优先用人物动作带出环境
- 禁止大段环境白描（"空气中弥漫着……远处是……近处有……"）
- 好的范例：`他一脚踢开歪斜的门板，霉味扑面——这地方至少荒了三年。`

### 2.5 句式多样性

- 禁止连续 3 句相同句式（如连续 3 个"他……"开头）
- 长短句交替：2-3 个短句后接 1 个长句，或反之
- 避免排比过度（连续排比 ≤ 3 项）

## Layer 3: 后处理（StyleRefiner）

### 润色规则

StyleRefiner 对初稿逐项执行：

1. **黑名单扫描**：全文搜索 `ai-blacklist.json` 中所有词条
2. **逐个替换**：命中项替换为风格相符的自然表达，替代词需符合上下文语境
3. **句式调整**：
   - 句长偏离 style-profile 的 avg_sentence_length > 30% 的句子进行拆分或合并
   - 相邻 5 句中出现 ≥ 2 个相同句式 → 改写其中 1 句
4. **修改量控制**：总修改量 ≤ 原文 15%（字数变化比）

### 不可修改项

- 角色对话中的语癖和口头禅
- 情节因果链中的关键句
- 伏笔暗示语句
- 角色名、地名、术语

## Layer 4: 检测度量（QualityJudge）

### 风格自然度评分标准

| 分数 | AI 黑名单命中率 | 句式重复率 | style-profile 匹配度 |
|------|----------------|-----------|---------------------|
| 5 | 0 次/千字 | 0/5 句 | 完全匹配 |
| 4 | 1-2 次/千字 | ≤ 1/5 句 | 基本匹配 |
| 3 | 3-4 次/千字 | 2/5 句 | 部分偏移 |
| 2 | 5-7 次/千字 | ≥ 3/5 句 | 明显偏移 |
| 1 | > 7 次/千字 | 频繁重复 | 严重偏移 |

### 黑名单维护机制

- **初始化**：`${CLAUDE_PLUGIN_ROOT}/templates/ai-blacklist.json` 提供 ≥ 30 个常见 AI 高频中文用语
- **持续更新**：QualityJudge 检测到新高频 AI 用语时，建议追加到黑名单
- **用户自定义**：用户可手动添加/删除
- **误伤保护**：如果某个黑名单词是用户风格样本中的高频词，自动豁免
