## 5. Skills

### 5.1 SKILL.md — 核心方法论

## 文件路径：`skills/novel-writing/SKILL.md`

````markdown
# 小说创作方法论

本知识库为 novel 插件系统提供共享方法论。所有 Agent 在执行任务时自动参考本文档。

## 卷制滚动工作流

网文创作采用"边写边想"模式，以卷（30-50 章）为单位滚动规划：

1. **卷规划**：PlotArchitect 生成本卷大纲 + 伏笔计划 + L3 章节契约
2. **日更续写**：ChapterWriter → Summarizer → StyleRefiner → QualityJudge（单章流水线）
3. **定期检查**：每 10 章执行一致性检查 + 伏笔盘点 + 风格漂移监控
4. **卷末回顾**：全卷一致性报告 → 下卷铺垫建议 → 用户审核

核心循环状态机：`VOL_PLANNING → WRITING ⟲ (每章含内嵌门控+修订) → VOL_REVIEW → VOL_PLANNING`

## Spec-Driven Writing 原则

小说创作遵循"规范先行，实现随后，验收对齐规范"范式：

| 层级 | 内容 | 生成者 | 约束强度 |
|------|------|--------|---------|
| L1 世界规则 | 物理/魔法/社会硬约束 | WorldBuilder → `rules.json` | 不可违反 |
| L2 角色契约 | 能力边界/行为模式 | CharacterWeaver → `contracts` | 可变更需走协议 |
| L3 章节契约 | 前置/后置条件/验收标准 | PlotArchitect → `chapter-contracts/` | 可协商须留痕 |

验收采用双轨制：Contract Verification（合规检查 L1/L2/L3/LS，硬门槛）+ Quality Scoring（8 维度评分，软评估）。合规是编译通过，质量是 code review。

## 多线叙事体系

支持多 POV 群像、势力博弈暗线、跨卷伏笔交汇等复杂叙事结构：

- **小说级定义**：`storylines/storylines.json` 管理全部故事线（类型 + 范围 + 势力 + 桥梁关系）
- **卷级调度**：PlotArchitect 在卷规划时生成 `storyline-schedule.json`（volume_role: primary/secondary/seasoning + 交汇事件）
- **章级注入**：ChapterWriter 接收 storyline_context + concurrent_state + transition_hint
- **防串线**：三层策略（结构化 Context + 反串线指令 + QualityJudge 后验校验），每次续写为独立 LLM 调用
- **活跃线限制**：同时活跃 ≤ 4 条（DR-021 验证）

## 去 AI 化四层策略

| 层 | 手段 | 执行者 |
|----|------|--------|
| L1 风格锚定 | 用户样本 → style-profile.json | StyleAnalyzer |
| L2 约束注入 | 黑名单 + 语癖 + 反直觉 + 句式多样 | ChapterWriter |
| L3 后处理 | 替换 AI 用语 + 匹配风格指纹 | StyleRefiner |
| L4 检测度量 | 黑名单命中率 + 句式重复率 + 风格匹配度 | QualityJudge |

核心指标：AI 黑名单命中 < 3 次/千字，相邻 5 句重复句式 < 2。

## 质量评分标准

8 维度加权评分（详见 `references/quality-rubric.md`）：

| 维度 | 权重 |
|------|------|
| 情节逻辑 | 18% |
| 角色塑造 | 18% |
| 沉浸感 | 15% |
| 风格自然度 | 15% |
| 伏笔处理 | 10% |
| 节奏 | 8% |
| 情感冲击 | 8% |
| 故事线连贯 | 8% |

门控：≥4.0 通过，3.5-3.9 二次润色，3.0-3.4 自动修订，<3.0 通知用户。有 contract violation（含 LS hard）时无条件强制修订。

## Context 管理

每次 Agent 调用的 context 预算控制在 ~25K tokens：
- 系统 prompt + 风格 + 黑名单：~7K（固定）
- 卷大纲 + 本章大纲 + 伏笔：~4K
- 近 3 章摘要：~3K（滑动窗口）
- 角色档案（活跃）：~5K（按需加载）
- 当前状态：~3-5K（定期裁剪）

摘要替代全文，确保第 500 章时 context 仍稳定。
````

---

### 5.2 去 AI 化规则详解

## 文件路径：`skills/novel-writing/references/style-guide.md`

````markdown
# 去 AI 化规则详解

本文档定义 novel 插件系统的完整去 AI 化策略，供 ChapterWriter、StyleRefiner、QualityJudge 参考。

## Layer 1: 风格锚定（输入层）

### 风格指纹提取

StyleAnalyzer 从用户样本中提取以下可量化特征：

- **avg_sentence_length**：平均句长（字数），用于校准生成文本的句式节奏
- **dialogue_ratio**：对话占全文比例，控制叙述与对话的平衡
- **rhetoric_preferences**：修辞偏好列表（频率标注），如比喻、排比、短句切换
- **forbidden_words**：作者从不使用的词汇（精准收录，不过度泛化）
- **character_speech_patterns**：角色语癖，需有样本中的具体例句支撑

### 风格样本降级方案

当用户无自有样本时：
1. **仿写模式**（推荐）：指定参考作者 → 提取风格指纹 → 标记 `source_type: "reference"`
2. **先写后提**：用户先写 1 章 → 再提取
3. **预置模板**：选择预设风格模板（轻松幽默/热血少年/细腻言情等）→ 微调

### 风格漂移监控

每 5 章提取一次当前输出的风格特征，与 style-profile.json 对比：
- 句长偏移 > 20% → 警告
- 对话比例偏移 > 15% → 警告
- 新出现的高频 AI 用语 → 追加到黑名单

**自动纠偏**：当漂移超阈值时，将偏离项写入 `style-drift.json`，自动注入后续 ChapterWriter 和 StyleRefiner 的 context：
```json
{
  "detected_chapter": 25,
  "drifts": [
    {"metric": "avg_sentence_length", "baseline": 18, "current": 24, "directive": "句子过长，回归短句节奏"},
    {"metric": "dialogue_ratio", "baseline": 0.4, "current": 0.28, "directive": "对话偏少，增加角色互动"}
  ],
  "injected_to": ["ChapterWriter", "StyleRefiner"]
}
```
纠偏指令会持续注入直至下次检测确认回归基线（偏移 < 10%）。

## Layer 2: 约束注入（生成层）

ChapterWriter prompt 中注入以下硬约束：

### 2.1 AI 用语黑名单

从 `ai-blacklist.json` 加载，生成时完全禁止。包含但不限于：
- 情感描写类：不禁、莫名、油然而生、心中暗道、嘴角微微上扬
- 过渡连接类：与此同时、值得一提的是、毫无疑问
- 形容夸张类：宛如、恍若、仿佛置身于
- 详见 `${CLAUDE_PLUGIN_ROOT}/templates/ai-blacklist.json`

### 2.2 角色语癖

每个重要角色至少定义 1 个口头禅或说话习惯：
- 口头禅出现频率：每 2-3 次对话出现 1 次（不可每句都加）
- 语癖需符合角色背景（文化人用文言、江湖人用俚语）
- 不同角色的语癖必须可区分

### 2.3 反直觉细节

每章至少 1 处"反直觉"的生活化细节，例如：
- 打斗中途想起锅里还炖着汤
- 修炼突破时被蚊子咬了一口
- 严肃对话中对方裤子上有个洞

目的：打破 AI 生成文本的"完美感"和"刻板感"。

### 2.4 场景描写限制

- 场景描写最多 2 句，优先用人物动作带出环境
- 禁止大段环境白描（"空气中弥漫着……远处是……近处有……"）
- 好的范例：`他一脚踢开歪斜的门板，霉味扑面——这地方至少荒了三年。`

### 2.5 句式多样性

- 禁止连续 3 句相同句式（如连续 3 个"他……"开头）
- 长短句交替：2-3 个短句后接 1 个长句，或反之
- 避免排比过度（连续排比 ≤ 3 项）

## Layer 3: 后处理（StyleRefiner）

### 润色规则

StyleRefiner 对初稿逐项执行：

1. **黑名单扫描**：全文搜索 `ai-blacklist.json` 中所有词条
2. **逐个替换**：命中项替换为风格相符的自然表达，替代词需符合上下文语境
3. **句式调整**：
   - 句长偏离 style-profile 的 avg_sentence_length > 30% 的句子进行拆分或合并
   - 相邻 5 句中出现 ≥ 2 个相同句式 → 改写其中 1 句
4. **修改量控制**：总修改量 ≤ 原文 15%（字数变化比）

### 不可修改项

- 角色对话中的语癖和口头禅
- 情节因果链中的关键句
- 伏笔暗示语句
- 角色名、地名、术语

## Layer 4: 检测度量（QualityJudge）

### 风格自然度评分标准

| 分数 | AI 黑名单命中率 | 句式重复率 | style-profile 匹配度 |
|------|----------------|-----------|---------------------|
| 5 | 0 次/千字 | 0/5 句 | 完全匹配 |
| 4 | 1-2 次/千字 | ≤ 1/5 句 | 基本匹配 |
| 3 | 3-4 次/千字 | 2/5 句 | 部分偏移 |
| 2 | 5-7 次/千字 | ≥ 3/5 句 | 明显偏移 |
| 1 | > 7 次/千字 | 频繁重复 | 严重偏移 |

### 黑名单维护机制

- **初始化**：`${CLAUDE_PLUGIN_ROOT}/templates/ai-blacklist.json` 提供 ≥ 30 个常见 AI 高频中文用语
- **持续更新**：QualityJudge 检测到新高频 AI 用语时，建议追加到黑名单
- **用户自定义**：用户可手动添加/删除
- **误伤保护**：如果某个黑名单词是用户风格样本中的高频词，自动豁免
````

---

### 5.3 8 维度评分标准详解

## 文件路径：`skills/novel-writing/references/quality-rubric.md`

````markdown
# 8 维度质量评分标准

本文档定义 QualityJudge 的完整评分标准。每维度 1-5 分，综合分 = 加权均值。

## 1. 情节逻辑（plot_logic）— 权重 0.18

评估章节与大纲的一致性、内部逻辑、因果链完整性。

| 分数 | 标准 |
|------|------|
| 5 | 完美推进大纲目标，因果链清晰无断裂，无逻辑漏洞 |
| 4 | 推进大纲主要目标，因果链基本完整，可能有 1 处小瑕疵 |
| 3 | 大纲目标部分达成，有 1-2 处逻辑不够顺畅 |
| 2 | 偏离大纲方向，有明显逻辑断裂或矛盾 |
| 1 | 严重偏离大纲，情节混乱无逻辑 |

## 2. 角色塑造（character）— 权重 0.18

评估角色言行是否符合档案设定、性格连续性、L2 契约合规。

| 分数 | 标准 |
|------|------|
| 5 | 角色言行完全符合人设，语癖自然，性格连贯，契约无违反 |
| 4 | 角色基本符合人设，语癖偶有缺失，1 处细微不一致 |
| 3 | 角色大体符合，但有 1-2 处明显不符合性格设定 |
| 2 | 角色表现与人设多处矛盾，或违反 L2 契约 |
| 1 | 角色面目模糊、自相矛盾，或严重违反契约 |

## 3. 伏笔处理（foreshadowing）— 权重 0.10

评估伏笔的埋设自然度、推进合理性、回收满足感。

| 分数 | 标准 |
|------|------|
| 5 | 伏笔埋设隐蔽自然，推进不突兀，回收有"啊哈"感 |
| 4 | 伏笔处理得当，但自然度或满足感稍弱 |
| 3 | 伏笔存在但不够自然（过于明显或过于隐晦） |
| 2 | 遗漏应处理的伏笔，或伏笔处理生硬 |
| 1 | 完全忽视伏笔任务，或伏笔处理导致情节矛盾 |

## 4. 沉浸感（immersion）— 权重 0.15

评估画面感、氛围营造、详略得当。

| 分数 | 标准 |
|------|------|
| 5 | 文笔流畅优美，用词精准传神，修辞恰到好处 |
| 4 | 文笔流畅，用词准确，偶有平淡之处 |
| 3 | 文笔通顺，但有重复用词或表达不够精准 |
| 2 | 文笔平庸，用词单一，有明显语病 |
| 1 | 语句不通，病句频出，严重影响阅读 |

## 5. 节奏（pacing）— 权重 0.08

评估冲突强度、情节张弛、阅读节奏。

| 分数 | 标准 |
|------|------|
| 5 | 节奏精准，张弛有度，推进与留白恰到好处 |
| 4 | 节奏流畅，冲突有吸引力，偶有拖沓 |
| 3 | 节奏尚可，但部分段落拖沓或过于急促 |
| 2 | 节奏失衡，明显拖沓或跳跃 |
| 1 | 节奏混乱，无法正常推进 |

## 6. 风格自然度（style_naturalness）— 权重 0.15

评估去 AI 化效果，基于可量化指标。

| 分数 | AI 黑名单命中率 | 句式重复率（相邻 5 句） | style-profile 匹配度 |
|------|----------------|----------------------|---------------------|
| 5 | 0 次/千字 | 0 个重复句式 | 句长、对话比、修辞完全匹配 |
| 4 | 1-2 次/千字 | ≤ 1 个重复句式 | 大部分匹配，轻微偏差 |
| 3 | 3-4 次/千字 | 2 个重复句式 | 部分匹配，有偏移 |
| 2 | 5-7 次/千字 | ≥ 3 个重复句式 | 明显不匹配 |
| 1 | > 7 次/千字 | 频繁重复 | 完全不匹配 |

## 7. 情感冲击（emotional_impact）— 权重 0.08

评估情感起伏、读者代入感、情绪共鸣。

| 分数 | 标准 |
|------|------|
| 5 | 情感冲击强烈，读者强代入感，情绪共鸣持久 |
| 4 | 情感有起伏，读者能投入，共鸣感良好 |
| 3 | 情感起伏不明显，代入感一般 |
| 2 | 情感平板，难以产生代入感 |
| 1 | 情感缺失，读者无法投入 |

## 8. 故事线连贯（storyline_coherence）— 权重 0.08

评估多线叙事的切线流畅度、读者跟线难度、并发线暗示自然度。

| 分数 | 标准 |
|------|------|
| 5 | 切线无缝，读者无跟线困难，并发线暗示自然巧妙 |
| 4 | 切线流畅，偶有跟线小困惑，暗示基本自然 |
| 3 | 切线可辨识但略显突兀，或暗示过于明显/缺失 |
| 2 | 切线生硬，读者可能迷失，暗示不当 |
| 1 | 切线混乱，线索混淆，严重影响阅读 |

**注意**：单线章节（非切线章）此维度默认 4 分，仅评估与上下文的衔接自然度。

## 综合分计算

```
overall = plot_logic × 0.18
        + character × 0.18
        + immersion × 0.15
        + foreshadowing × 0.10
        + pacing × 0.08
        + style_naturalness × 0.15
        + emotional_impact × 0.08
        + storyline_coherence × 0.08
```

## 门控决策

| 综合分范围 | 合规状态 | 行动 |
|-----------|---------|------|
| 任意 | 有 violation | 强制修订（无论分数多高） |
| 4.0-5.0 | 无 violation | 直接通过 |
| 3.5-3.9 | 无 violation | StyleRefiner 二次润色后通过 |
| 3.0-3.4 | 无 violation | ChapterWriter（Opus）自动修订 |
| 2.0-2.9 | 无 violation | 通知用户，人工审核决定重写范围 |
| < 2.0 | 无 violation | 强制全章重写 |
````

