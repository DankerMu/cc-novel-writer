## 6. 工作流设计

### Layer 1: 快速起步（首次使用，30 分钟内产出）

```
用户提供：题材 + 主角概念 + 核心冲突
  ↓
1a. WorldBuilder（轻量模式）→ 核心规则 ≤3 条
1b. CharacterWeaver → 主角 + 1-2 配角
1c. WorldBuilder 协助初始化 storylines.json（从设定中派生初始故事线，默认 1 条主线）
1d. 用户提供 1-3 章风格样本 → StyleAnalyzer 提取 style-profile
  ↓
1e. ChapterWriter 试写 3 章 → StyleRefiner 润色 → QualityJudge 评分
  ↓
1f. 用户确认：继续 / 调整风格 / 换题材
```

**说明**：步骤 1c 的 storylines 初始化默认最小化——仅创建一条 `main_arc` 主线。用户可在后续卷规划时通过 PlotArchitect 逐步增加副线/暗线，无需在快速起步阶段定义完整的故事线体系。同时活跃故事线建议 ≤ 4 条 [DR-021](../../v5/dr/dr-021-llm-multi-thread-narrative.md)。

**验收标准**：30 分钟内输出 3 章（含设定 + 初始 storylines.json），用户确认后进入卷制循环。

### Layer 2: 卷制循环（每卷 30-50 章）

```
2a. 卷规划
    PlotArchitect → 本卷大纲 + 伏笔计划
    用户审核大纲（可调整）

2b. 日更续写（核心循环，每次 1-3 章）
    用户请求 → Orchestrator 组装 context
    → ChapterWriter 生成初稿
    → Summarizer 生成摘要 + 更新状态
    → StyleRefiner 去 AI 化润色
    → QualityJudge 评分
    → 通过 → 保存 + 更新 checkpoint
    → 未通过 → 质量门控处理

2c. 定期检查（每 10 章）
    一致性检查（NER）
    伏笔状态盘点
    风格漂移监控

2d. 卷末回顾
    全卷一致性报告
    伏笔完成度统计
    下卷铺垫建议
    用户审核 + 决定下卷方向
```

### Layer 3: 全局维护（跨卷、按需调用）

- **世界观扩展**：随剧情需要，调用 WorldBuilder 增量更新
- **角色管理**：新增角色 / 退场角色 / 更新关系
- **全局伏笔**：跨卷伏笔状态追踪
- **风格校准**：每 5 章提取风格特征，检测漂移并自动纠偏——偏离项写入 `style-drift.json`，注入后续 ChapterWriter/StyleRefiner context，持续到回归基线

### 质量门控

| QualityJudge 评分 | 行动 |
|-------------------|------|
| 4.0-5.0 | 直接通过 |
| 3.5-3.9 | StyleRefiner 二次润色后通过 |
| 3.0-3.4 | 标记问题，ChapterWriter（Opus）自动修订 |
| 2.0-2.9 | 通知用户，人工审核决定重写范围 |
| < 2.0 | 强制全章重写 |

### 用户审核点

| 触发条件 | 展示内容 | 用户选项 |
|---------|---------|---------|
| 快速起步完成 | 3 章试写 + 设定 + 风格分析 | 继续 / 调整 / 重来 |
| 卷规划完成 | 本卷大纲 | 确认 / 修改 / 调整章数 |
| 每 5 章 | 质量简报（均分+问题章节） | 继续 / 回看 / 调整方向 |
| 低分章节 | 章节 + 评分详情 | 自动修订 / 手动改 / 接受 |
| 卷末 | 一致性报告 + 伏笔 + 铺垫 | 确认 / 修改 / 加角色 |

